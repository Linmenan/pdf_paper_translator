根据你提供的最新代码（`app.js`, `server.py` 以及之前的 `workflow_utils.py` 上下文），我为你整理了 **Step 2：任务列表 (Task Dashboard)** 界面的详细功能特性文档。

你可以将此内容更新到你的项目文档（如 `README.md` 或独立的 `features.md`）中。

---

# 📋 任务列表与翻译控制 (Task Dashboard Features)

任务列表视图（Step 2）是系统的“控制塔”，连接了 **PDF 提取（Step 1）** 与 **结果预览（Step 3）**。在此界面，用户可以核对提取结果、预览 LLM 输入、并以非阻塞方式监控翻译进度。

## 1\. 核心交互特性

### A. 智能提示词预览 (Advanced Prompt Inspector)

为了让用户清楚地知道“发给 LLM 的到底是什么”，系统内置了强大的预览交互逻辑：

- **实时合成预览**: 鼠标悬停在左侧“原文 (Source)”单元格时，系统会实时拼装 **System Prompt** + **User Input**。
- **动态资源注入**: 提示词模板中的 `{ref_map_str}` 占位符会被自动替换为当前论文真实的 **引用映射表 (Ref Map)**（例如 `Fig. 1 -> Figure_1.png`），实现所见即所得。
- **滚轮穿透 (Wheel-Through)**: 由于提示框跟随鼠标，为了查看长文本，用户无需移动鼠标进入提示框，只需在原文单元格上**直接滚动滚轮**，悬浮的提示框即会响应滚动。
- **点击锁定 (Click-to-Lock)**:
  - **单击原文**: 锁定提示框（边框变蓝），此时鼠标可以移入提示框内进行文本选择或复制。
  - **再次单击**: 解锁并关闭提示框。

### B. 异步翻译与状态同步 (Async Translation & Polling)

翻译过程经过重构，不再阻塞 UI，支持断点续传与实时反馈：

- **非阻塞触发**: 点击 **"🚀 开始翻译"** 后，后端异步启动 LLM 任务，前端界面保持响应。
- **智能轮询 (Smart Polling)**:
  - 系统自动开启递归检查（每 2 秒一次），从后端获取最新的 `_llm_cache.json` 状态。
  - **进度可视化**: 按钮状态变更为 `⏳ 翻译进行中...`，并实时显示 **(剩余: N)** 任务数。
  - **实时点亮**: 列表中的任务卡片会随着后台的完成，逐个从“⏳ 待处理”变为“✓ 已完成”并显示译文。
- **自动跳转**: 当检测到所有任务状态不再是 `pending` 时，系统自动停止轮询，生成最终 HTML 报告并跳转至 **Step 3 结果预览**。

### C. [TODO]数据兜底与手动刷新

- **进入时自动刷新**: 进入 Step 2 页面时，会自动尝试拉取一次后端数据。即便提取过程未完全结束（如文件写入延迟），系统也会尝试加载，避免页面卡死。
- **手动刷新按钮**: 顶部提供 **"🔄 刷新状态"** 按钮。如果用户在后台（或其他标签页）完成了翻译，点击此按钮可强制同步最新进度或重新加载失败的任务。

## 2\. 数据展示结构

| 区域           | 内容说明                                         | 数据源映射                      |
| :------------- | :----------------------------------------------- | :------------------------------ |
| **顶部统计**   | 显示总段落数、总字符数、剩余待翻译数。           | `translationTasks` 数组聚合计算 |
| **元数据行**   | 显示任务类型（Body/Caption/Title 等）及唯一 ID。 | `task.type`, `task.id`          |
| **左侧：原文** | 显示提取出的原始文本。支持鼠标悬停预览 Prompt。  | `task.src` (后端清洗后的文本)   |
| **右侧：译文** | 初始显示占位符，翻译成功后实时显示中文结果。     | `task.trans` (LLM 生成结果)     |

## 3\. 状态流转图

```mermaid
graph TD
    A[Step 1: 提取完成] -->|自动跳转/手动选择| B(Step 2: 任务列表页)
    B -->|进入页面| C{尝试加载 Cache JSON}
    C -->|成功| D[渲染任务列表 & RefMap]
    C -->|失败| E[显示空列表 (允许手动刷新)]

    D --> F[用户点击: 开始翻译]
    F --> G[后端启动异步任务]
    G --> H[前端开启 Smart Polling (2s间隔)]

    H -->|轮询中| I[更新任务状态 & 剩余计数]
    I --> J{是否全部完成?}
    J -->|否| H
    J -->|是| K[停止轮询 -> 生成报告 -> 跳转 Step 3]
```

## 4\. 异常处理机制

- **UUID 兼容性**: 前端集成了 UUID 生成的 Polyfill，确保在旧版浏览器或非安全上下文（无 `crypto.randomUUID`）下也能正常生成对象 ID，防止白屏。
- **数据加载保护**: `selectPaper` 增加了 `try-catch` 保护，即使无法读取 `_llm_cache.json`（例如提取被中断），也会强制进入 Step 2，允许用户通过“刷新”或“重新提取”来恢复，而不是卡在 Step 1。

[DONE]目前经过步骤 1.布局标注 -> 开始提取 -> 自动跳转到 2.任务列表 这时任务列表显示正常的，但是此时返回文献库，再次进入 2.任务列表就无法显示任务列表了，也就是说任务列表页面没有做到离线文件缓存。应支持已拆分好的文献直接进入任务列表并正常显示。
[DONE]2.任务列表页面有“开始翻译”与“开始翻译所有任务”两个按钮设计重复，应将“开始翻译所有任务删除”。
[DONE]点击开始翻译后会立即自动跳转到 3.结果预览页面，应该不自动跳转，留在该页面，前端按钮“开始翻译”变为停止翻译，并且与后端翻译的代码进行交互，由后端主动发起页面刷新，每完成一个任务，就更新该任务的翻译结果，总数量统计信息。
[FIXME]在所有任务完成翻译后，此时自动跳转到 3.结果预览页面
