<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI å­¦æœ¯æ–‡çŒ®ç¿»è¯‘å·¥ä½œå°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css" />
  </head>
  <body>
    <div id="app">
      <div v-if="isBusy" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">{{ busyMsg }}</div>
      </div>

      <div v-if="!currentPaper" class="dashboard-container">
        <div class="dashboard-header">
          <div class="dashboard-title">ğŸ“„ æœ¬åœ°æ–‡çŒ®ç¿»è¯‘å·¥ä½œå°</div>
          <div style="color: #777; margin-top: 5px">
            Local Paper Translation Workbench
          </div>
        </div>

        <div class="paper-list-container">
          <div class="list-header">
            <div class="col-status">å½“å‰çŠ¶æ€</div>
            <div class="col-name">æ–‡ä»¶å</div>
            <div class="col-action">æ“ä½œ</div>
          </div>

          <div v-for="p in papers" class="paper-row" @click="selectPaper(p)">
            <div class="col-status">
              <span
                class="status-badge"
                :class="{
                  'done': p.status === 'å·²å®Œæˆ' || p.status === 'ç¿»è¯‘å®Œæˆ',
                  'trans': p.status.includes('ç¿»è¯‘ä¸­') || p.status === 'å·²ç¿»è¯‘',
                  'extract': p.status === 'å·²æå–'
                }"
              >
                {{ p.status }}
              </span>
            </div>

            <div class="paper-name-cell" :title="p.filename">
              {{ p.filename }}
            </div>

            <div class="col-action">
              <span class="row-arrow">&rarr;</span>
            </div>
          </div>

          <div
            v-if="papers.length === 0"
            style="padding: 40px; text-align: center; color: #999"
          >
            ç›®å½•ä¸ºç©ºï¼Œè¯·æ”¾å…¥ PDF æ–‡ä»¶ã€‚
          </div>
        </div>
      </div>

      <div v-else class="workspace-layout">
        <div class="navbar">
          <div class="nav-left">
            <button class="back-btn" @click="goBack">
              <span>&larr;</span> æ–‡çŒ®åº“
            </button>
            <div class="current-doc-title">{{ currentPaper.filename }}</div>
          </div>

          <div class="stepper">
            <div class="step" :class="{active: step===1}" @click="step=1">
              1. å¸ƒå±€æ ‡æ³¨
            </div>
            <div class="step" :class="{active: step===2}" @click="step=2">
              2. ä»»åŠ¡åˆ—è¡¨
            </div>
            <div class="step" :class="{active: step===3}" @click="step=3">
              3. ç»“æœé¢„è§ˆ
            </div>
          </div>

          <div class="action-area">
            <button
              v-if="step===1"
              class="btn btn-text"
              @click="saveLayout(true)"
            >
              ğŸ’¾ ä¿å­˜ (Ctrl+S)
            </button>
            <button
              v-if="step===1"
              class="btn btn-warning"
              @click="triggerExtract"
            >
              âš¡ å¼€å§‹æå–
            </button>

            <button
              v-if="step===2"
              class="btn"
              :class="isTranslating ? 'btn-danger' : 'btn-primary'"
              @click="triggerTranslate"
            >
              <span v-if="isTranslating">ğŸ›‘ åœæ­¢ç¿»è¯‘ (Stop Task)</span>
              <span v-if="!isTranslating">{{ translationBtnLabel }}</span>
            </button>

            <button
              v-if="step===3"
              class="btn btn-text"
              @click="generateReport"
            >
              ğŸ”„ åˆ·æ–°æŠ¥å‘Š
            </button>
          </div>
        </div>

        <div class="main-content">
          <div v-show="step===1" class="editor-wrapper">
            <div class="toolbox">
              <div class="toolbox-header">
                <div class="section-title">æ ‡æ³¨å·¥å…·</div>
              </div>

              <div class="tool-grid">
                <div
                  v-for="(t, idx) in tools"
                  class="tool-btn"
                  :class="{active: currentTool === t.type}"
                  @click="setTool(t.type)"
                  :title="t.label"
                >
                  <span class="color-dot" :style="{background: t.color}"></span>
                  {{ t.type }} [{{idx+1}}]
                </div>
              </div>

              <div
                style="
                  padding: 10px 15px;
                  background: #fff;
                  border-bottom: 1px solid #e0e0e0;
                  font-size: 0.85em;
                "
              >
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 5px;
                  "
                >
                  <span style="font-weight: bold; color: var(--primary)"
                    >å½“å‰: #{{ pendingId }}</span
                  >
                  <span
                    :style="{color: pendingRole==='Body'?'#2c3e50':'#e67e22', fontWeight:'bold'}"
                    >{{ pendingRole }}</span
                  >
                </div>
                <div style="display: flex; gap: 5px">
                  <button
                    class="btn-xs"
                    :class="{active: pendingRole==='Body'}"
                    style="flex: 1"
                    @click="setPendingRole('Body')"
                  >
                    ç”»å†…å®¹
                  </button>
                  <button
                    class="btn-xs"
                    :class="{active: pendingRole==='Caption'}"
                    style="flex: 1"
                    @click="setPendingRole('Caption')"
                  >
                    ç”»æ ‡é¢˜
                  </button>
                </div>
              </div>

              <div class="prop-panel" v-if="selectedItem">
                <div
                  class="section-title"
                  style="margin-top: 0; color: var(--primary)"
                >
                  ä¿®æ”¹é€‰ä¸­é¡¹
                </div>
                <div class="prop-row">
                  <span class="prop-label">ID:</span>
                  <input
                    class="id-input"
                    :value="selectedItem.id"
                    @input="updateSelectedId"
                  />
                </div>
                <div
                  class="prop-row"
                  v-if="['Figure','Table','Algorithm'].includes(selectedItem.type)"
                >
                  <div class="role-group">
                    <label class="role-radio"
                      ><input
                        type="radio"
                        value="Body"
                        :checked="selectedItem.role === 'Body'"
                        @change="updateSelectedRole('Body')"
                      />å†…å®¹</label
                    >
                    <label class="role-radio"
                      ><input
                        type="radio"
                        value="Caption"
                        :checked="selectedItem.role === 'Caption'"
                        @change="updateSelectedRole('Caption')"
                      />æ ‡é¢˜</label
                    >
                  </div>
                </div>
              </div>
              <div
                class="prop-panel"
                v-if="!selectedItem"
                style="
                  text-align: center;
                  color: #ccc;
                  font-size: 0.85em;
                  padding: 15px;
                "
              >
                (ç‚¹å‡»ç”»æ¡†ä¿®æ”¹å±æ€§)
              </div>

              <div
                class="toolbox-header"
                style="margin-top: auto; border-top: 1px solid #e0e0e0"
              >
                <div class="section-title">å·²æ ‡åˆ—è¡¨ (æœ¬é¡µ)</div>
              </div>

              <div class="list-panel">
                <div
                  v-for="group in groupedItems"
                  :key="group.type + '-' + group.id"
                  style="border-bottom: 1px solid #eee"
                >
                  <div
                    style="
                      padding: 5px 15px;
                      background: #f9f9f9;
                      font-weight: bold;
                      font-size: 0.85em;
                      color: #555;
                      display: flex;
                      justify-content: space-between;
                    "
                  >
                    <span>{{ group.displayLabel }}</span>
                  </div>
                  <div
                    v-for="item in group.children"
                    class="list-item"
                    :class="{selected: selectedItem && selectedItem.uuid === item.uuid}"
                    @click="selectFromList(item)"
                  >
                    <span class="list-sub-item"
                      >{{ item.role === 'Body' ? 'å†…å®¹åŒºåŸŸ' : 'æ ‡é¢˜æ–‡å­—'
                      }}</span
                    >
                  </div>
                </div>
                <div
                  v-if="groupedItems.length === 0"
                  style="
                    padding: 20px;
                    text-align: center;
                    color: #ccc;
                    font-size: 0.8em;
                  "
                >
                  æš‚æ— æ•°æ®
                </div>
              </div>

              <div class="page-nav">
                <button
                  class="page-btn"
                  @click="prevPage"
                  :disabled="pageIdx<=0"
                >
                  &lt;
                </button>
                <span>{{ pageIdx + 1 }} / {{ totalPages }}</span>
                <button
                  class="page-btn"
                  @click="nextPage"
                  :disabled="pageIdx>=totalPages-1"
                >
                  &gt;
                </button>
              </div>
            </div>

            <div class="canvas-container">
              <div class="canvas-shadow-box"><canvas id="c"></canvas></div>
            </div>
          </div>

          <div v-if="step===2" class="task-dashboard" style="width: 100%">
            <div class="task-header">
              <div class="task-stats">
                <span style="margin-right: 15px; font-size: 1.1em">
                  è¿›åº¦:
                  <b
                    :style="{color: completedTaskCount === translationTasks.length ? '#27ae60' : '#e67e22'}"
                  >
                    {{ completedTaskCount }}
                  </b>
                  / {{ translationTasks.length }}
                </span>
                <span style="color: #999; font-size: 0.9em"
                  >(æ€»å­—ç¬¦: {{ taskStats.chars }})</span
                >
              </div>
            </div>

            <div class="task-list-container">
              <div
                v-for="(task, idx) in translationTasks"
                :key="idx"
                class="task-card"
              >
                <div class="task-meta-row">
                  <div>
                    <span class="type-tag" :class="`type-${task.type}`"
                      >{{ task.type }}</span
                    >
                    <span style="margin-left: 10px">ID: {{ task.id }}</span>
                  </div>
                  <div style="font-size: 0.9em">
                    <span
                      v-if="task.status === 'success'"
                      style="color: #27ae60; font-weight: bold"
                      >âœ… å·²å®Œæˆ</span
                    >
                    <span
                      v-if="task.status === 'failed'"
                      style="color: #e74c3c; font-weight: bold"
                      >âŒ å¤±è´¥</span
                    >
                    <span
                      v-if="task.status !== 'success' && task.status !== 'failed'"
                      style="color: #999"
                      >â³ å¾…å¤„ç†</span
                    >
                  </div>
                </div>

                <div class="task-content-row">
                  <div
                    class="source-col"
                    @mousemove="showPromptPreview($event, task)"
                    @mouseleave="hidePromptPreview"
                    @click.stop="toggleTooltipLock"
                    style="cursor: help"
                  >
                    {{ task.src }}
                  </div>

                  <div class="target-col">
                    <div class="trans-placeholder" v-if="!task.trans">
                      <span v-if="task.status === 'pending'"
                        >æ­£åœ¨æ€è€ƒä¸­...</span
                      >
                      <span v-if="task.status !== 'pending'"
                        >ç¿»è¯‘åå°†æ˜¾ç¤ºåœ¨æ­¤å¤„...</span
                      >
                    </div>
                    <div v-if="task.trans">{{ task.trans }}</div>
                  </div>
                </div>

                <div
                  id="prompt-tooltip"
                  class="prompt-tooltip"
                  style="display: none"
                >
                  <div class="pt-header">LLM è¾“å…¥é¢„è§ˆ (System + User)</div>
                  <div class="pt-content"></div>
                </div>
              </div>

              <div
                v-if="translationTasks.length === 0"
                style="text-align: center; padding: 50px; color: #999"
              >
                æ²¡æœ‰æ‰¾åˆ°æå–å†…å®¹ï¼Œè¯·æ£€æŸ¥ Step 1 æ ‡æ³¨æ˜¯å¦æ­£ç¡®ã€‚
              </div>
            </div>
          </div>

          <div
            v-if="step===3"
            style="width: 100%; height: 100%; background: #fff"
          >
            <iframe
              v-if="reportUrl"
              :src="reportUrl"
              class="preview-frame"
            ></iframe>
            <div
              v-if="!reportUrl"
              style="
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                color: #777;
              "
            >
              <div style="text-align: center">
                <p>ç­‰å¾…åŠ è½½æŠ¥å‘Š...</p>
                <button class="btn btn-primary" @click="generateReport">
                  ğŸ”„ æ‰‹åŠ¨åˆ·æ–°
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="/static/js/app.js"></script>
  </body>
</html>
